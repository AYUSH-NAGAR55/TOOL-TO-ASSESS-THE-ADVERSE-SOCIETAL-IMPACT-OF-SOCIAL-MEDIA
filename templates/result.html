<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Media Analysis Result</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
    .header { text-align: center; padding: 40px 20px; }
    .header h1 { color: #0d6efd; }
    .header p { color: #6c757d; }

    .card { border-radius: 15px; transition: transform 0.3s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

    .circle-chart { max-width: 180px; margin: auto; }

    .scroll-box { max-height: 400px; overflow-y: auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: inset 0 0 8px rgba(0,0,0,0.05); }
    .post-card { border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #fafafa; }
    .metrics { font-size: 0.9rem; color: #495057; margin-top: 5px; }
    .metrics i { margin-right: 5px; }
    .metric-badge { font-size: 0.85rem; padding: 0.3em 0.6em; margin-right: 5px; border-radius: 12px; }
    .extracted-text { max-height: 250px; overflow-y: auto; background: #fff; padding: 15px; border-radius: 10px; box-shadow: inset 0 0 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .badge-icon { margin-right: 5px; }
    hr { margin: 10px 0; border-top: 1px dashed #dee2e6; }
    .back-btn { margin-top: 30px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> Social Media Impact Dashboard</h1>
        <p>Analysis of sentiment, content type, and engagement across platforms</p>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card text-center p-4 shadow-sm">
                <h5 class="mb-3">Overall Sentiment</h5>
                <canvas id="sentimentChart" class="circle-chart"></canvas>
                <span id="sentimentBadge" class="badge fs-6 mt-3">Loading...</span>
                {% if sentiment == 'NEGATIVE' and category != 'Raw Data' and category != 'Uncertain' and category != 'Technology' %}
                    <small class="text-danger mt-2">Reason: {{ category }}</small>
                {% endif %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="card text-center p-4 shadow-sm">
                <h5 class="mb-3">Content Category</h5>
                <canvas id="categoryChart" class="circle-chart"></canvas>
                <span class="badge bg-info fs-6 mt-3">{{ category|default("Unknown")|capitalize }}</span>
            </div>
        </div>
    </div>
    
    {% if extracted_text %}
    <div class="card shadow-sm p-4 mb-4">
        <h5 class="mb-3 text-center text-primary">üìù Extracted Text</h5>
        <div class="extracted-text">
            <pre>{{ extracted_text }}</pre>
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm p-4">
                <h5 class="text-center text-primary mb-3">üó£Ô∏è Emotions Detected</h5>
                {% if emotion_results %}
                    <ul class="list-group list-group-flush">
                        {% for emotion in emotion_results %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ emotion.label|capitalize }}
                                <span class="badge bg-primary rounded-pill">{{ (emotion.score*100)|round(2) }}%</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">No emotion data available.</p>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-4">
                <h5 class="text-center text-primary mb-3">üîé Keywords</h5>
                {% if keywords %}
                    <ul class="list-group list-group-flush">
                        {% for keyword, count in keywords.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ keyword }}
                                <span class="badge bg-info rounded-pill">{{ count }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">No keywords found.</p>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-4">
                <h5 class="text-center text-primary mb-3">‚ú® Aspect Sentiment</h5>
                {% if absa_results %}
                    <ul class="list-group list-group-flush">
                        {% for aspect, data in absa_results.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="badge badge-icon {% if data.sentiment=='POSITIVE' %} bg-success {% else %} bg-danger {% endif %}">
                                    {{ data.sentiment }}
                                </span>
                                {{ aspect|capitalize }}
                                <span class="badge bg-secondary rounded-pill">{{ (data.score*100)|round(2) }}%</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">No aspect sentiment data available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card shadow-sm p-4 mb-4">
        <h5 class="mb-3 text-center text-primary">üí¨ Sentiment & Engagement Details</h5>
        <div class="scroll-box">
            {% for item in sentiment_results %}
            <div class="post-card">
                <p><strong>Text:</strong> {{ item.comment or item.text }}</p>
                <p class="metrics">
                    <span class="badge {% if item.sentiment.label=='POSITIVE' %} bg-success {% elif item.sentiment.label=='NEGATIVE' %} bg-danger {% else %} bg-secondary {% endif %} metric-badge">
                        Sentiment: {{ item.sentiment.label if item.sentiment is defined else "N/A" }}
                    </span>
                    <span class="badge bg-primary metric-badge">
                        Score: {{ item.sentiment.score|round(2) if item.sentiment is defined else "N/A" }}
                    </span>
                    {% if item.platform == 'twitter' %}
                        {% if item.likes is defined %}<span class="badge bg-warning text-dark metric-badge"><i class="fas fa-thumbs-up"></i>{{ item.likes }}</span>{% endif %}
                        {% if item.retweets is defined %}<span class="badge bg-info text-white metric-badge"><i class="fas fa-retweet"></i>{{ item.retweets }}</span>{% endif %}
                        {% if item.replies is defined %}<span class="badge bg-secondary metric-badge"><i class="fas fa-comment"></i>{{ item.replies }}</span>{% endif %}
                    {% elif item.platform == 'reddit' %}
                        {% if item.upvotes is defined %}<span class="badge bg-success metric-badge"><i class="fas fa-arrow-up"></i>{{ item.upvotes }}</span>{% endif %}
                        {% if item.comments is defined %}<span class="badge bg-dark metric-badge"><i class="fas fa-comments"></i>{{ item.comments }}</span>{% endif %}
                    {% elif item.platform == 'facebook' %}
                        {% if item.likes is defined %}<span class="badge bg-warning text-dark metric-badge"><i class="fas fa-thumbs-up"></i>{{ item.likes }}</span>{% endif %}
                        {% if item.shares is defined %}<span class="badge bg-danger metric-badge"><i class="fas fa-share"></i>{{ item.shares }}</span>{% endif %}
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="text-center back-btn">
        <a href="/" class="btn btn-lg btn-outline-primary shadow-sm"><i class="fas fa-arrow-left"></i> Back to Survey</a>
    </div>
</div>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v17.0"></script>

<script>
// --- Sentiment Breakdown ---
const sentimentPositive = parseInt("{{ sentiment_results|selectattr('sentiment.label','equalto','POSITIVE')|list|length }}");
const sentimentNegative = parseInt("{{ sentiment_results|selectattr('sentiment.label','equalto','NEGATIVE')|list|length }}");
const sentimentNeutral  = parseInt("{{ sentiment_results|selectattr('sentiment.label','equalto','NEUTRAL')|list|length }}");

let majoritySentiment = "Neutral";
if (sentimentPositive > sentimentNegative && sentimentPositive > sentimentNeutral) majoritySentiment = "Positive";
else if (sentimentNegative > sentimentPositive && sentimentNegative > sentimentNeutral) majoritySentiment = "Negative";

const badgeColors = { "Positive": "bg-success", "Negative": "bg-danger", "Neutral": "bg-secondary" };
const badge = document.getElementById("sentimentBadge");
badge.innerText = majoritySentiment;
badge.className = `badge fs-6 mt-3 ${badgeColors[majoritySentiment]}`;

// Sentiment Doughnut Chart
new Chart(document.getElementById("sentimentChart"), {
    type: 'doughnut',
    data: {
        labels: ["Positive", "Negative", "Neutral"],
        datasets: [{
            data: [sentimentPositive, sentimentNegative, sentimentNeutral],
            backgroundColor: ["#28a745", "#dc3545", "#6c757d"],
            borderWidth: 1
        }]
    },
    options: { 
        cutout: "70%", 
        plugins: { legend: { display: true, position: 'bottom' } } 
    }
});

// Category Chart
const categoryScore = parseFloat("{{ category_score or 0 }}");
new Chart(document.getElementById("categoryChart"), {
    type: 'doughnut',
    data: {
        labels: ["Confidence", "Remaining"],
        datasets: [{
            data: [categoryScore, 100 - categoryScore],
            backgroundColor: ["#17a2b8", "#e9ecef"],
            borderWidth: 1
        }]
    },
    options: { cutout: "70%", plugins: { legend: { display: false } } }
});
</script>

</body>
</html>